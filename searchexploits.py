# first run msfconsole on linux, then enter cmd > load msgrpc
import pymetasploit3 as msf
from pymetasploit3.msfrpc import MsfRpcClient
from pymetasploit3.msfconsole import MsfRpcConsole
import pandas as pd
import csv
import time
import re
#import subprocess as sub
#import shlex
import os
global global_positive_out
global_positive_out = list()
global global_console_status
global_console_status = False
global client
global console
global rhost

def show_search(line):
    data = line.strip().split()
    # print(data)
    if len(data) > 6 and data[0].isdigit():
        if re.search('^[0-9]{4}-[0-9]{2}-[0-9]{2}$',data[2]):
            row = {'#': data[0], 'Name': data[1], 'Disclosure Date': data[2], 'Rank': data[3], 'Check': data[4]}
        else:
            row = {'#': data[0], 'Name': data[1], 'Disclosure Date': ' ', 'Rank': data[2], 'Check': data[3]}
        str = ''
        for i in range(5, len(data)):
            str = str + ' ' + data[i]
        row['Desc'] = str
        #print("line", row)
        global_positive_out.append(row)
        df = pd.DataFrame.from_records(global_positive_out)
        #print(df.head())
        #cleanup()
        df.to_csv('outputs/exploits.csv')
    # print(search_results)

def cleanup():
    f =open('outputs/exploits.csv','r+')
    f.seek(0)
    f.truncate()
    f.close()
    return

def read_console(console_data):
    global global_console_status
    global_console_status = console_data['busy']
    # print(global_console_status)
    sigdata = console_data['data'].rstrip().split('\n')
    l = len(sigdata)
    # print(sigdata)
    #
    # if '[+]' in console_data['data']:
    sigdata = console_data['data'].rstrip().split('\n')
    global_positive_out.clear()
    for line in sigdata:
        #print("Line :",line)
        show_search(line)
        '''
        if '[+]' in line:
            global_positive_out.append(line)
        '''
    return global_positive_out

def search(host,tgt):
    # cleanup()
    global rhost
    rhost = host['IP']
    ser = (tgt[5].split()[0]+' '+tgt[5].split()[1].split('/')[0]) if len(tgt[5].split())>1 else (tgt[5].split()[0])
    print("[*] searching for ",ser)
    output = console.execute('search ' + ser + ' rank:great rank:excellent rank:normal rank:average')
    #time.sleep(10)
    #if output:
    return output
# Connecting Client to msfrpcd

client = MsfRpcClient('abc123', port=55552, ssl=False)
console = MsfRpcConsole(client, cb=read_console)
'''
def main():
    tgt = ('192.168.1.8', 'tcp', '1524', 'open', 'bindshell', '')
    search(tgt)
# print(console_data['data'])
main()
'''
